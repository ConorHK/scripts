#!/usr/bin/env python

# notify with command result using ntfy
import os
import sys
from requests import post
from subprocess import CalledProcessError
from subprocess import run as subprocess_run


def _send_notification(command, error):
    url = os.environ["NTFY_LINK"]

    data = {
        "topic": url,
        "message": f"* {command} * completed with return code {error}",
        "title": "Command success",
        "priority": 3,
    }

    if error:
        data["title"] = "Command failure"
        data["priority"] = 4
    post("https://ntfy.sh", json=data)


def _run_command(command):
    process = subprocess_run(command, shell=True)
    if process.returncode != 0:
        raise CalledProcessError(process.returncode, process.args)


def main():
    command = " ".join(sys.argv[1:])
    try:
        _run_command(command)
        _send_notification(command, 0)
    except CalledProcessError as exc:
        _send_notification(command, exc.returncode)


if __name__ == "__main__":
    main()
